{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'home_user.html' %} 
<div class="min-h-screen px-4" style="background-color: rgba(150, 155, 74, 0.2); padding: 20px;">
    <div id="order-form" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">

        <h2 class="text-xl font-bold mb-6 text-center">Pesan Jasa</h2>
        <form method="POST" action="{% url 'feat_2_green:buat_pemesanan' subcategory_id %}" id="order-form">

            {% csrf_token %}
            <select id="session-dropdown" class="w-full p-2 border rounded-md focus:outline-none focus:ring focus:border-[#969b4a]">
                <option value="">Pilih Sesi</option>

                {% for session in sessions %}
                    <option value="{{ session.Sesi }}" data-price="{{ session.Harga }}">
                       Sesi {{ session.Sesi }} - {{ session.Harga }}
                    </option>
                {% endfor %}
            </select>
            
            <!-- Tanggal Pemesanan -->
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Tanggal Pemesanan:</label>
                <input id="order-date" type="text" readonly class="w-full p-2 border rounded-md bg-gray-100">
            </div>
        
            <!-- Kode Diskon -->
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Diskon:</label>
                <input id="discount-code" type="text" placeholder="Kode Diskon" class="w-full p-2 border rounded-md focus:outline-none focus:ring focus:border-[#969b4a]">
            </div>
        
            <!-- Total Pembayaran -->
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Total Pembayaran:</label>
                <p id="total-payment" class="text-lg font-semibold text-gray-800">Rp {{ s.Harga }}</p>
            </div>
        
            <!-- Metode Pembayaran -->
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Metode Pembayaran:</label>
                <select id="payment-method" class="w-full p-2 border rounded-md focus:outline-none focus:ring focus:border-[#969b4a]">
                    <option value="">Pilih Metode</option>
                        {% for method in payment_methods %}
                            <option value="{{ method.Id }}">{{ method.Nama }}</option>
                        {% endfor %}
                </select>
            </div>
        
            <!-- Tombol Pesan Jasa -->
            <button type="submit" id="submit-order" class="block w-full py-2 text-center bg-[#969b4a] text-white rounded-md hover:bg-[#646733] focus:outline-none focus:ring focus:ring-[#969b4a]">
                Pesan
            </button>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
    const sessionDropdown = document.getElementById("session-dropdown");
    const totalPaymentElement = document.getElementById("total-payment");
    const discountCodeInput = document.getElementById("discount-code");
    let initialTotalPayment = 0; // Total awal tanpa diskon

    // Event listener untuk dropdown
    sessionDropdown.addEventListener("change", (event) => {
        const selectedOption = event.target.options[event.target.selectedIndex];
        const sessionPriceRaw = selectedOption.getAttribute("data-price");

        // Pastikan harga dalam format angka
        const sessionPrice = parseInt(sessionPriceRaw.replace(/\D/g, ''), 10) || 0;
        initialTotalPayment = sessionPrice; // Simpan total awal
        updateTotalPayment(initialTotalPayment);
    });

    // Event listener untuk input kode diskon
    discountCodeInput.addEventListener("input", () => {
        const discountCode = discountCodeInput.value.toUpperCase();

        fetch(`/validate_discount/?code=${discountCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    const discountedTotal = initialTotalPayment * (1 - data.discount / 100);
                    updateTotalPayment(discountedTotal);
                } else {
                    updateTotalPayment(initialTotalPayment);
                }
            })
            .catch(() => {
                updateTotalPayment(initialTotalPayment); // Jika terjadi error
            });
    });

    // Fungsi untuk mengupdate elemen total pembayaran
    function updateTotalPayment(amount) {
        totalPaymentElement.textContent = `Rp ${amount.toLocaleString('id-ID')},00`;
    }

    // Tanggal otomatis
    const orderDateInput = document.getElementById("order-date");
    const today = new Date().toISOString().split('T')[0];
    orderDateInput.value = today;

    // Event listener tombol submit
    const submitButton = document.getElementById("submit-order");
    submitButton.addEventListener("click", (event) => {
        const paymentMethod = document.getElementById("payment-method").value;

        if (!paymentMethod) {
            alert("Silakan pilih metode pembayaran.");
            event.preventDefault(); // Jangan submit form
        }
    });
});

</script>

{% endblock content %}
